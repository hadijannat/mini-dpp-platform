import { readFile, writeFile } from 'node:fs/promises';
import path from 'node:path';
import { fileURLToPath } from 'node:url';
import YAML from 'yaml';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const rootDir = path.resolve(__dirname, '..', '..');
const docsDir = path.resolve(rootDir, 'docs/public/cirpass-stories');
const indexPath = path.resolve(docsDir, 'index.yaml');
const outputPath = path.resolve(
  rootDir,
  'frontend/src/features/cirpass-lab/stories.generated.ts',
);

function buildOutput(manifestVersion, payload) {
  if (!payload || typeof payload !== 'object') {
    throw new Error('Manifest payload must be an object.');
  }

  return {
    manifest_version: manifestVersion,
    story_version: typeof payload.story_version === 'string' ? payload.story_version : 'V3.1',
    generated_at:
      typeof payload.generated_at === 'string'
        ? payload.generated_at
        : new Date().toISOString(),
    source_status: 'fresh',
    stories: Array.isArray(payload.stories) ? payload.stories : [],
    feature_flags: {
      scenario_engine_enabled: true,
      live_mode_enabled: false,
      inspector_enabled: true,
    },
  };
}

function renderTs(manifest) {
  const serialized = JSON.stringify(manifest, null, 2);
  return `/* eslint-disable */\n// This file is auto-generated by scripts/generate-cirpass-stories.mjs\nimport type { CirpassLabManifest } from './schema/storySchema';\n\nexport const generatedCirpassManifest: CirpassLabManifest = ${serialized};\n`;
}

async function main() {
  const checkMode = process.argv.includes('--check');

  const indexRaw = await readFile(indexPath, 'utf8');
  const index = YAML.parse(indexRaw);
  if (!index || typeof index !== 'object') {
    throw new Error('Manifest index must be an object.');
  }

  const latest = typeof index.latest === 'string' ? index.latest.trim() : '';
  if (!latest) {
    throw new Error('Manifest index is missing `latest`.');
  }

  const manifests = index.manifests;
  if (!manifests || typeof manifests !== 'object') {
    throw new Error('Manifest index is missing `manifests` mapping.');
  }

  const manifestFileName = manifests[latest];
  if (typeof manifestFileName !== 'string' || manifestFileName.trim() === '') {
    throw new Error(`Manifest index does not map latest version '${latest}'.`);
  }

  const manifestPath = path.resolve(docsDir, manifestFileName);
  const manifestRaw = await readFile(manifestPath, 'utf8');
  const manifestPayload = YAML.parse(manifestRaw);

  const output = renderTs(buildOutput(latest, manifestPayload));

  if (checkMode) {
    let existing = '';
    try {
      existing = await readFile(outputPath, 'utf8');
    } catch {
      throw new Error(
        `Generated manifest is missing at ${outputPath}. Run npm run generate:cirpass-stories.`,
      );
    }

    if (existing !== output) {
      throw new Error(
        'Generated CIRPASS stories file is out of date. Run npm run generate:cirpass-stories.',
      );
    }

    console.log('CIRPASS generated stories are up to date.');
    return;
  }

  await writeFile(outputPath, output, 'utf8');
  console.log(`Wrote generated CIRPASS stories to ${outputPath}`);
}

main().catch((error) => {
  console.error('[cirpass-stories] generation failed:', error.message);
  process.exitCode = 1;
});
