version: "3.9"

services:
  # =============================================================================
  # PostgreSQL - Primary Data Store
  # =============================================================================
  postgres:
    image: postgres:16-alpine
    container_name: dpp-postgres
    environment:
      POSTGRES_USER: dpp_user
      POSTGRES_PASSWORD: dpp_dev_password_2024
      POSTGRES_DB: dpp_platform
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./infra/postgres/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dpp_user -d dpp_platform"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - dpp-network

  # =============================================================================
  # Redis - Caching and Rate Limiting
  # =============================================================================
  redis:
    image: redis:7-alpine
    container_name: dpp-redis
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy volatile-lru
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - dpp-network

  # =============================================================================
  # Keycloak - Identity Provider (OIDC)
  # =============================================================================
  keycloak:
    build:
      context: ./infra/keycloak
      dockerfile: Dockerfile
    image: dpp-keycloak:local
    container_name: dpp-keycloak
    command: start-dev --import-realm
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/${KEYCLOAK_DB_NAME:-keycloak}
      KC_DB_USERNAME: ${KEYCLOAK_DB_USERNAME:-keycloak}
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-keycloak_dev_password_2024}
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true
      KC_HOSTNAME_STRICT: false
      KC_HTTP_ENABLED: true
    volumes:
      - ./infra/keycloak/realm-export:/opt/keycloak/data/import:ro
    ports:
      - "${KEYCLOAK_HOST_PORT:-8080}:8080"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "bash",
          "-lc",
          "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\n\\r\\n' >&3 && grep -q '200' <&3",
        ]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 60s
    networks:
      - dpp-network

  # =============================================================================
  # Open Policy Agent - ABAC Policy Decision Point
  # =============================================================================
  opa:
    build:
      context: ./infra/opa
      dockerfile: Dockerfile
    image: dpp-opa:local
    container_name: dpp-opa
    command:
      - run
      - --server
      - --addr=0.0.0.0:8181
      - --log-level=info
      - --set=decision_logs.console=true
      - /policies
    volumes:
      - ./infra/opa/policies:/policies:ro
    ports:
      - "8181:8181"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8181/health"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 15s
    networks:
      - dpp-network

  # =============================================================================
  # MinIO - Object Storage for Large Attachments
  # =============================================================================
  minio:
    image: minio/minio:RELEASE.2024-01-16T16-07-38Z
    container_name: dpp-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minio_admin
      MINIO_ROOT_PASSWORD: minio_dev_password_2024
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - dpp-network

  # =============================================================================
  # Backend API - FastAPI Application
  # =============================================================================
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
      target: development
    container_name: dpp-backend
    command: >
      sh -c "python -m alembic upgrade head && python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"
    environment:
      - ENVIRONMENT=development
      - DATABASE_URL=postgresql+asyncpg://dpp_user:dpp_dev_password_2024@postgres:5432/dpp_platform
      - REDIS_URL=redis://redis:6379/0
      - KEYCLOAK_SERVER_URL=http://keycloak:8080
      - KEYCLOAK_REALM=dpp-platform
      - KEYCLOAK_CLIENT_ID=dpp-backend
      - KEYCLOAK_CLIENT_SECRET=backend-secret-dev
      - KEYCLOAK_ALLOWED_CLIENT_IDS=${KEYCLOAK_ALLOWED_CLIENT_IDS:-dpp-backend,dpp-frontend}
      - KEYCLOAK_ISSUER_URL_OVERRIDE=http://keycloak:8080/realms/dpp-platform
      - KEYCLOAK_JWKS_URL_OVERRIDE=http://keycloak:8080/realms/dpp-platform/protocol/openid-connect/certs
      - KEYCLOAK_ALLOWED_ISSUERS=http://localhost:${KEYCLOAK_HOST_PORT:-8080}/realms/dpp-platform
      - OPA_URL=http://opa:8181
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minio_admin
      - MINIO_SECRET_KEY=minio_dev_password_2024
      - LOG_LEVEL=DEBUG
      - IDTA_TEMPLATES_GITHUB_TOKEN=${IDTA_TEMPLATES_GITHUB_TOKEN:-}
      - IDTA_TEMPLATES_REPO_REF=${IDTA_TEMPLATES_REPO_REF:-1d4e0b45469f9260228ca6e99ff907c670476e2a}
      - RESOLVER_ENABLED=false
      - RESOLVER_BASE_URL=
      - RESOLVER_AUTO_REGISTER=true
      - REGISTRY_ENABLED=false
      - REGISTRY_AUTO_REGISTER=true
      - REGISTRY_EXTERNAL_URL=
      - REGISTRY_EXTERNAL_DISCOVERY_URL=
      - ENCRYPTION_MASTER_KEY=${ENCRYPTION_MASTER_KEY:-MDEyMzQ1Njc4OUFCQ0RFRjAxMjM0NTY3ODlBQkNERUY=}
      - DATASPACE_TCK_COMMAND=${DATASPACE_TCK_COMMAND:-}
      - DATASPACE_TCK_TIMEOUT_SECONDS=${DATASPACE_TCK_TIMEOUT_SECONDS:-120}
      - DATASPACE_TCK_ARTIFACT_DIR=${DATASPACE_TCK_ARTIFACT_DIR:-/tmp/dataspace-tck}
      - RFID_TDS_SERVICE_URL=http://rfid-tds:8080
      - RFID_TDS_TIMEOUT_SECONDS=5
    volumes:
      - ./backend:/app:cached
      - ./docs/public/cirpass-stories:/app/docs/public/cirpass-stories:ro
      - ./docs/public/regulatory-timeline:/app/docs/public/regulatory-timeline:ro
      - ./shared:/shared:ro
      - backend_cache:/app/.cache
    ports:
      - "${BACKEND_HOST_PORT:-8000}:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      opa:
        condition: service_healthy
    networks:
      - dpp-network

  # =============================================================================
  # RFID TDS Translator Sidecar
  # =============================================================================
  rfid-tds:
    build:
      context: ./infra/rfid-tds
      dockerfile: Dockerfile
    container_name: dpp-rfid-tds
    healthcheck:
      test:
        [
          "CMD",
          "bash",
          "-lc",
          "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /health HTTP/1.1\\r\\nHost: localhost\\r\\n\\r\\n' >&3 && grep -q '200' <&3",
        ]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - dpp-network

  # =============================================================================
  # Frontend - React Application (Development Server)
  # =============================================================================
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
      target: development
    container_name: dpp-frontend
    environment:
      - VITE_API_BASE_URL=http://localhost:${BACKEND_HOST_PORT:-8000}
      - VITE_API_BASE_URL_INTERNAL=http://backend:8000
      - VITE_KEYCLOAK_URL=http://localhost:${KEYCLOAK_HOST_PORT:-8080}
      - VITE_KEYCLOAK_URL_INTERNAL=http://keycloak:8080
      - VITE_KEYCLOAK_REALM=dpp-platform
      - VITE_KEYCLOAK_CLIENT_ID=dpp-frontend
    volumes:
      - ./frontend:/app:cached
      - ./shared:/shared:ro
      - /app/node_modules
    ports:
      - "5173:5173"
    depends_on:
      - backend
    networks:
      - dpp-network

  # =============================================================================
  # OPC UA Agent - Background Worker
  # =============================================================================
  opcua-agent:
    build:
      context: .
      dockerfile: backend/Dockerfile
      target: development
    container_name: dpp-opcua-agent
    command: >
      sh -c "python -m app.opcua_agent"
    environment:
      - ENVIRONMENT=development
      - DATABASE_URL=postgresql+asyncpg://dpp_user:dpp_dev_password_2024@postgres:5432/dpp_platform
      - REDIS_URL=redis://redis:6379/0
      - ENCRYPTION_MASTER_KEY=${ENCRYPTION_MASTER_KEY:-dGVzdC1rZXktMzItYnl0ZXMtbG9uZy4uLg==}
      - OPCUA_ENABLED=${OPCUA_ENABLED:-false}
    volumes:
      - ./backend:/app:cached
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - dpp-network

networks:
  dpp-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  minio_data:
  backend_cache:
