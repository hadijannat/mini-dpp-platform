name: DPP Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read

env:
  PYTHON_VERSION: "3.12"

jobs:
  dpp-pipeline:
    name: Refresh → Build → Export → Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@8d55fbecc275b1c35dbe060458839f8d30439ccf # v3

      - name: Install backend dependencies
        working-directory: backend
        run: uv sync --frozen --extra dev --extra test

      - name: Set up compliance tool env
        working-directory: backend
        run: |
          COMPLIANCE_CMD=$(python tests/tools/setup_compliance_tool_env.py)
          echo "COMPLIANCE_TOOL_CMD=$COMPLIANCE_CMD" >> $GITHUB_ENV

      - name: Start stack
        env:
          IDTA_TEMPLATES_GITHUB_TOKEN: ${{ github.token }}
          IDTA_TEMPLATES_REPO_REF: 1d4e0b45469f9260228ca6e99ff907c670476e2a
          ENCRYPTION_MASTER_KEY: MDEyMzQ1Njc4OUFCQ0RFRjAxMjM0NTY3ODlBQkNERUY=
        run: |
          set -euo pipefail
          SERVICES=(
            postgres
            redis
            keycloak
            opa
            minio
            rfid-tds
            backend
            frontend
            opcua-agent
            edc-postgres
            vault
            edc-controlplane
            edc-dataplane
          )
          for attempt in 1 2 3; do
            echo "Starting stack (attempt ${attempt}/3)..."
            if docker compose -f docker-compose.yml -f docker-compose.edc.yml up -d --build "${SERVICES[@]}"; then
              exit 0
            fi
            echo "Compose startup failed on attempt ${attempt}; retrying after cleanup..."
            docker compose -f docker-compose.yml -f docker-compose.edc.yml down -v || true
            sleep $((attempt * 20))
          done
          echo "ERROR: failed to start stack after 3 attempts"
          exit 1

      - name: Wait for backend health
        run: |
          curl --retry 30 --retry-all-errors --retry-delay 2 \
            --fail --silent --show-error http://localhost:8000/health

      - name: Wait for EDC controlplane health
        run: |
          curl --retry 40 --retry-all-errors --retry-delay 2 \
            --fail --silent --show-error http://localhost:19191/api/check/health

      - name: Wait for Keycloak realm ready
        run: |
          echo "Waiting for Keycloak realm import to complete..."
          for i in $(seq 1 60); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -X POST http://localhost:8080/realms/dpp-platform/protocol/openid-connect/token \
              -d "client_id=dpp-backend" \
              -d "client_secret=backend-secret-dev" \
              -d "username=publisher" \
              -d "password=publisher123" \
              -d "grant_type=password" 2>/dev/null || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "Keycloak realm ready (got 200 on token request)"
              exit 0
            fi
            echo "  Attempt $i/60: HTTP $HTTP_CODE (waiting 3s...)"
            sleep 3
          done
          echo "ERROR: Keycloak realm not ready after 180s"
          docker compose logs keycloak | tail -50
          exit 1

      - name: Wait for RFID TDS sidecar health
        run: |
          echo "Waiting for RFID TDS sidecar health..."
          for i in $(seq 1 60); do
            HEALTH_STATUS=$(docker inspect -f '{{.State.Health.Status}}' dpp-rfid-tds 2>/dev/null || echo "missing")
            if [ "$HEALTH_STATUS" = "healthy" ]; then
              echo "RFID TDS sidecar is healthy"
              exit 0
            fi
            echo "  Attempt $i/60: health=$HEALTH_STATUS (waiting 3s...)"
            sleep 3
          done
          echo "ERROR: RFID TDS sidecar not healthy after 180s"
          docker compose -f docker-compose.yml -f docker-compose.edc.yml logs rfid-tds | tail -100
          exit 1

      - name: Guardrail check for plaintext connector secrets
        working-directory: backend
        env:
          DATABASE_URL: postgresql+asyncpg://dpp_user:dpp_dev_password_2024@localhost:5432/dpp_platform
        run: uv run python tools/check_plaintext_connector_secrets.py

      - name: Run pipeline + golden tests
        working-directory: backend
        env:
          RUN_E2E: "1"
          RUN_GOLDENS: "1"
          DPP_BASE_URL: "http://localhost:8000"
          KEYCLOAK_BASE_URL: "http://localhost:8080"
          KEYCLOAK_REALM: "dpp-platform"
          KEYCLOAK_CLIENT_ID: "dpp-backend"
          KEYCLOAK_CLIENT_SECRET: "backend-secret-dev"
          DPP_USERNAME: "publisher"
          DPP_PASSWORD: "publisher123"
          DPP_TENANT: "default"
          PIPELINE_REPORT_DIR: "${{ github.workspace }}/test-results"
        run: uv run pytest -m "e2e or golden" --run-e2e --run-goldens -q

      - name: Dump container logs on failure
        if: failure()
        run: |
          echo "=== Keycloak logs ==="
          docker compose -f docker-compose.yml -f docker-compose.edc.yml logs keycloak | tail -100
          echo ""
          echo "=== Backend logs ==="
          docker compose -f docker-compose.yml -f docker-compose.edc.yml logs backend | tail -100
          echo ""
          echo "=== EDC controlplane logs ==="
          docker compose -f docker-compose.yml -f docker-compose.edc.yml logs edc-controlplane | tail -100
          echo ""
          echo "=== EDC dataplane logs ==="
          docker compose -f docker-compose.yml -f docker-compose.edc.yml logs edc-dataplane | tail -100
          echo ""
          echo "=== RFID TDS logs ==="
          docker compose -f docker-compose.yml -f docker-compose.edc.yml logs rfid-tds | tail -100

      - name: Upload pipeline artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: dpp-pipeline-artifacts
          path: test-results/

      - name: Teardown
        if: always()
        run: docker compose -f docker-compose.yml -f docker-compose.edc.yml down -v
